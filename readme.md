# koishi-plugin-loliy-novelai

[![npm](https://img.shields.io/npm/v/koishi-plugin-loliy-novelai?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-loliy-novelai)

基于 Loliy API 和 Hua API 的 AI 画图插件

## 支持的 API 平台

1. Loliy API
   - 官网：https://www.loliy.top/
   - 支持所有尺寸（标准尺寸、大图尺寸、壁纸尺寸）
   - 价格实惠

2. Hua API
   - 官网：https://hua.shigure.top/
   - 仅支持标准尺寸
   - 需要授权密钥
   - 官方密钥可选

## 配置项

### 基础设置
- `apiType`: 选择使用的 API (loliy 或 hua)
- `apiKeys`: Loliy API密钥列表 (可选，可添加多个Key同时处理多张图片)
- `huaAuthKeys`: Hua API授权密钥列表
- `huaNaiKeys`: Hua API官方密钥列表 (可选)
- `useHuaCache`: 是否使用Hua API的服务器缓存 (默认关闭=不使用缓存)
- `defaultSizeCategory`: 默认尺寸类别
  - 标准尺寸 (832x1216)
  - 大图尺寸 (1024x1536) - 仅 Loliy API 支持
  - 壁纸尺寸 (1088x1920) - 仅 Loliy API 支持
  - 小图尺寸 (512x768)
- `defaultOrientation`: 默认图片方向
  - 竖图 (高度 > 宽度)
  - 横图 (宽度 > 高度)
  - 方图 (宽度 = 高度)
- `model`: 默认使用的模型
- `enableLargeSize`: 是否启用大图尺寸(消耗更多点数，仅Loliy API支持)
- `enableWallpaperSize`: 是否启用壁纸尺寸(消耗更多点数，仅Loliy API支持)
- `negativePrompt`: 默认负面提示词
- `sampler`: 采样器
- `cfgScale`: 提示词相关性 (1.0-10.0，支持小数值，如5.2、6.8等)
- `steps`: 生成步数 (1-50)
- `noiseSchedule`: 噪声调度

### 尺寸说明

每种尺寸类别都包含三种方向：
- 竖图：适合人物立绘
- 横图：适合风景
- 方图：适合头像、物品

可用尺寸：
- 标准尺寸：832x1216 / 1216x832 / 1024x1024（两个平台都支持）
- 大图尺寸：1024x1536 / 1536x1024 / 1472x1472（仅 Loliy API）
- 壁纸尺寸：1088x1920 / 1920x1088（仅 Loliy API）
- 小图尺寸：512x768 / 768x512 / 640x640（仅 Loliy API）

注意：使用 Hua API 时会自动使用标准尺寸，即使选择了其他尺寸也会自动调整。

## 使用方法

帮助命令：
- `绘画菜单`或`绘画功能` - 查看AI绘画功能菜单
- `剩余次数`或`查询次数` - 查询今日剩余绘图次数
- `群组限制`或`查询限制` - 查询当前群组的绘图次数限制

基础命令：
- `画` - 生成AI图片
- `#nai` - 生成AI图片（画的替代命令）
- `再来一张`、`再画一张`或`重画` - 使用上次的提示词重新生成图片（无需重新输入）
  - 支持指定数量：`重画2张`、`再来三张`、`再画5张`等（中文数字和阿拉伯数字均可）
  - 最大生成数量受插件配置的`最大绘图数量`限制（默认为1）

方向关键词（支持完整词和简写）：
- 横图/横：生成横向图片
- 方图/方：生成方形图片
- 竖图/竖：生成竖向图片（默认）

特殊选项：
- `-O`：临时禁用画师提示词（不使用画师提示词列表中的内容）
  - 此选项对当前一次生成有效，不会影响后续使用
  - 当您想要纯粹使用自己的提示词时非常有用
  - 可以放在命令的任意位置，例如：`画 -O 1girl` 或 `画 1girl -O`
  - 对于含有特定画风或画师风格的提示词特别有用，避免风格冲突

模型快捷选择（在画和nai命令中都可使用）：
- 支持以下模型关键词（可以放在描述文本中的任意位置）：
  - `v4` - 使用 NAI Diffusion V4 完整版
  - `v4.5c` - 使用 NAI Diffusion V4.5 先行版
  - `v4c` - 使用 NAI Diffusion V4 先行版
  - `v3` - 使用 NAI Diffusion Anime V3
  - `furry` 或 `v3f` - 使用 NAI Diffusion Furry V3

组合使用示例：
- `#nai v4c 横 1girl, ` - 使用V4先行版生成横图女孩
- `画 v4.5c 方图 1girl, ` - 使用V4.5先行版生成方形女孩
- `画 方 v3 1girl, ` - 使用V3模型生成方形女孩
- `画 -O 横图 1girl, ` - 生成横图女孩，不使用画师提示词
- `#nai 壁纸 furry 竖 1girl, ` - 使用Furry模型生成竖向壁纸女孩图片
- `画 -O 壁纸 v4 竖 1girl, ` - 使用V4模型生成竖向壁纸女孩图片，不使用画师提示词
- `再来一张` - 使用上次的提示词和参数重新生成图片
- `重画` - 与"再来一张"功能相同，使用上次的提示词重新生成
- `重画3张` - 使用上次的提示词生成3张图片
- `再来几张` - 随机生成2-4张图片（"几"会随机转换为2-4的数字）

注意：
1. 方向关键词（横/方/竖）和其完整形式（横图/方图/竖图）都可以使用
2. 模型关键词(v4/v4c/v3/furry/v3f)可以放在描述文本中的任意位置
3. 如果使用未启用的特殊尺寸，会自动使用普通尺寸继续生成
4. 壁纸尺寸不支持方图，如果指定方图+壁纸会自动使用普通尺寸方图
5. `-O`选项可以放在描述文本中的任意位置，用于临时禁用画师提示词
   - 当您使用包含特定画风的提示词时（如"Studio Ghibli style"），建议使用此选项避免与画师提示词风格冲突
   - 如果您已经在提示词中指定了画师标签（如"artist:xxx"），系统会自动跳过添加随机画师提示词，无需使用`-O`选项
   - 此选项特别适合想要完全控制生成结果艺术风格的场景
6. `再来一张`、`再画一张`和`重画`命令功能完全一致，可以使用任意一个
   - 这些命令会使用您上一次生成图片时的所有参数（包括提示词、方向、尺寸和模型等）
   - 可以通过设置`randomArtistOnRedraw`选项控制是否重用上次的画师提示词或随机选择新的画师提示词
   - 非常适合想要尝试不同种子值的情况，可以快速生成多张风格相似但细节不同的图片
   - 如果您之前没有使用过画图命令，使用这些命令会提示"没有找到记录"
   - 支持生成多张图片，格式为"重画N张"、"再来N张"、"再画N张"
     - 支持中文数字（一、二/两/俩、三...十）和阿拉伯数字（1-10）
     - 支持"几"作为特殊数量，会随机生成图片
       - 随机范围由插件配置的"几"的随机范围最小值和最大值决定（默认为2-4张）
       - 可在插件配置中设置`jrandomMin`和`jrandomMax`自定义随机范围
     - 当指定的数量超过配置的最大值时，会自动限制为最大值
     - 可以用"张"作为后缀也可以省略，如"再来3张"或"再来3"

### 高级设置

在插件配置中可以设置以下高级参数：

- **质量提示词**：将设置的提示词自动添加到用户输入的后面
- **画师提示词列表**：可以添加多个画师提示词，每次生成图片时会随机选择其中一个添加到提示词前面
  - 如果想临时禁用画师提示词，可以在命令中添加`-O`选项
  - 例如：`画 -O 1girl`将不使用画师提示词生成图片
  - 这个选项对当前一次生成有效，不会影响其他用户或后续使用
- **负面提示词**：用于排除不想要的元素，默认值为常见的负面提示词
- **采样器**：根据模型自动调整可用选项
  - NAI Diffusion V4 模型: k_euler_ancestral(默认)、k_euler、k_dpmpp_2s_ancestral、k_dpmpp_2m_sde、k_dpmpp_2m、k_dpmpp_sde
  - NAI Diffusion V3 模型: 上述所有选项 + ddim_v3
- **提示词相关性**：控制生成图像与提示词的相关程度，范围 1.0-10.0，支持设置小数值（如5.2、6.8等）
- **生成步数**：控制生成的精细程度，范围 20-50
- **噪声调度**：根据模型自动调整可用选项
  - NAI Diffusion V4 模型: karras(默认)、exponential、polyexponential
  - NAI Diffusion V3 模型: 上述所有选项 + native

### 特殊功能
- `useForwardMessage`: 使用合并转发发送图片（注意：目前主要支持 QQ 和 OneBot 平台，其他平台可能不支持）
- `autoRecall`: 自动撤回生成的图片和详细信息（不会撤回"正在生成图片..."的提示）
- `recallDelay`: 自动撤回延迟时间(秒)，默认50秒
- `autoRecallPrompt`: 自动撤回提示消息，默认关闭
  - 开启后会自动撤回以下类型的提示消息：
    - "正在生成图片..."提示
    - "已将提示词翻译为..."提示
    - 队列等待提示（如"您当前排在第x位..."）
    - 剩余次数提示
    - 错误提示消息
  - 不影响最终生成的图片和图片信息
  - 可以配合图片自动撤回功能使用
- `promptRecallDelay`: 提示消息撤回延迟时间(秒)，默认10秒
- `contentMode`: 发送内容模式
  - 仅图片：只发送生成的图片
  - 详细模式：图片和详细信息一起发送，一起撤回
- `enableTranslation`: 是否启用提示词自动翻译功能(中文→英文)，默认关闭
- `showTranslationResult`: 是否显示翻译结果，默认开启
- `maxDrawCount`: 单次重画命令最大生成数量，默认为1张
  - 该设置限制`重画N张`和`再来N张`命令的最大生成数量
  - 当用户输入的数量超过此设置值时，会自动限制为该值
  - 可设置范围为1-10，建议设置为合理的数值以避免API过载
- `jrandomMin`: "几"的随机范围最小值，默认为2
  - 当用户使用"重画几张"、"再来几张"等命令时，"几"会被转换为此范围内的随机数
  - 可设置范围为1-5
- `jrandomMax`: "几"的随机范围最大值，默认为4
  - 当用户使用含"几"的命令时，随机生成的最大数量
  - 可设置范围为2-10
  - 系统会确保最小值小于等于最大值
- `randomArtistOnRedraw`: 重画时是否随机选择画师提示词，默认开启
  - 开启时：每次使用"重画"/"再来一张"命令时都会随机选择一个新的画师提示词
  - 关闭时：使用"重画"/"再来一张"命令时会使用上一次生成图片时的画师提示词
  - 如果用户想保持画风一致，建议关闭此选项
  - 该设置不影响-O选项的功能

**自动翻译功能**：启用后，用户输入的中文提示词会自动翻译成英文，再发送给AI生成图片。这有助于产生更好的结果，因为大部分AI模型对英文prompt的理解更好。插件内置了IP伪装功能，可以绕过翻译API的请求频率限制。

### 重试设置
- `maxRetries`: API请求失败时的最大重试次数，默认3次
- `retryDelay`: 重试之间的延迟时间(毫秒)，默认1000ms

### 用户限制
- `enableDailyLimit`: 是否启用每日绘图次数限制，默认关闭
- `dailyLimit`: 每个用户每日最大绘图次数，默认30次（仅在启用限制时生效）
- `whitelistUsers`: 白名单用户ID列表，这些用户不受每日限制（仅在启用限制时生效）
- `groupDailyLimits`: 不同群组的每日绘图次数限制配置（优先级高于全局限制）
  - 每个配置项包含群组ID和对应的每日限制次数
  - 可以为不同的白名单群组设置不同的每日绘图次数限制
  - 未设置特殊限制的群组将使用全局限制（dailyLimit）
  - 用户可以使用`.群组限制`或`查询限制`命令查看当前群组的限制设置

### 群组限制
- `enableGroupWhitelist`: 是否启用群组白名单，默认关闭
  - 启用后只有白名单内的群可以使用绘图功能
  - 如果启用白名单但列表为空，则所有群组都无法使用
  - 私聊不受群组限制影响
- `groupWhitelist`: 群组白名单列表（仅在启用群组白名单时生效）
- `enableGroupBlacklist`: 是否启用群组黑名单，默认关闭
  - 启用后黑名单内的群无法使用绘图功能
  - 私聊不受群组限制影响
- `groupBlacklist`: 群组黑名单列表（仅在启用群组黑名单时生效）
- `showRestrictionMessage`: 是否显示群组限制提示消息，默认开启
  - 开启时会回复限制提示，如"当前群组不在白名单中"等
  - 关闭时不会回复任何限制提示消息
  - 不影响其他功能消息的显示

注意：
1. 白名单和黑名单不能同时启用，如果同时启用，白名单优先生效
2. 启用白名单但未添加任何群组时，所有群组都将无法使用绘图功能
3. 私聊消息不受群组限制影响，可以正常使用
4. 关闭限制提示消息后，被限制的群组将收不到任何回应

### 提示词设置
- `enableDefaultPrompt`: 是否启用质量提示词，默认关闭
- `defaultPrompt`: 质量提示词，会自动添加到用户输入的后面
  - 例如：设置为"masterpiece, best quality"，用户输入"1girl"，最终使用的提示词为"1girl, masterpiece, best quality"
  - 如果设置为空，即使启用了此功能也不会添加任何内容

### API 特性对比

| 功能 | Loliy API | Hua API |
|------|-----------|---------|
| 标准尺寸 | ✓ | ✓ |
| 大图尺寸 | ✓ | ✗ |
| 壁纸尺寸 | ✓ | ✗ |
| 小图尺寸 | ✓ | ✗ |
| 服务器缓存 | ✗ | ✓ |
| 官方密钥支持 | ✗ | ✓ |
| 多Key并发 | ✓ | ✓ |
